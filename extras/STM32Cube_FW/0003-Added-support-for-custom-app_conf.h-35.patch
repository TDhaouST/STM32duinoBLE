From 56bf751554bb993c041a92e774274d69a7a837b7 Mon Sep 17 00:00:00 2001
From: TLIG Dhaou <dhaou.tlig-ext@st.com>
Date: Wed, 27 Jul 2022 11:23:10 +0200
Subject: [PATCH 3/4] Added support for custom app_conf.h (#35)

Signed-off-by: TLIG Dhaou <dhaou.tlig-ext@st.com>
---
 src/utility/STM32Cube_FW/app_conf_default.h | 72 ++++++++++++++-------
 1 file changed, 48 insertions(+), 24 deletions(-)

diff --git a/src/utility/STM32Cube_FW/app_conf_default.h b/src/utility/STM32Cube_FW/app_conf_default.h
index 1d5e06a..492340d 100644
--- a/src/utility/STM32Cube_FW/app_conf_default.h
+++ b/src/utility/STM32Cube_FW/app_conf_default.h
@@ -1,8 +1,8 @@
 /**
   ******************************************************************************
-  * @file    app_conf.h
+  * @file    app_conf_default.h
   * @author  MCD Application Team
-  * @brief   Application configuration file for STM32WPAN Middleware.
+  * @brief   Default application configuration file for STM32WPAN Middleware.
   ******************************************************************************
   * @attention
   *
@@ -17,11 +17,8 @@
   */

 /* Define to prevent recursive inclusion -------------------------------------*/
-#ifndef APP_CONF_H
-#define APP_CONF_H
-
-#include "hw.h"
-#include "ble_bufsize.h"
+#ifndef APP_CONF_DEFAULT_H
+#define APP_CONF_DEFAULT_H

 /******************************************************************************
  * Application Config
@@ -48,7 +45,9 @@
  * Define Tx Power
  */

-#define CFG_TX_POWER                      (0x18) /* -0.15dBm */
+#ifndef CFG_TX_POWER
+  #define CFG_TX_POWER (0x18) /* -0.15dBm */
+#endif

 /******************************************************************************
  * BLE Stack
@@ -57,32 +56,41 @@
  * Maximum number of simultaneous connections that the device will support.
  * Valid values are from 1 to 8
  */
-#define CFG_BLE_NUM_LINK            8
+#ifndef CFG_BLE_NUM_LINK
+  #define CFG_BLE_NUM_LINK 2
+#endif

 /**
  * Maximum number of Services that can be stored in the GATT database.
- * Note that the GAP and GATT services are automatically added so this parameter should be 2 plus the number of user services
+ * Note that the GAP and GATT services are automatically added so this parameter should be 2 plus the number of user
+ * services
  */
+#ifndef CFG_BLE_NUM_GATT_SERVICES
 #define CFG_BLE_NUM_GATT_SERVICES   8
+#endif

 /**
  * Maximum number of Attributes
- * (i.e. the number of characteristic + the number of characteristic values + the number of descriptors, excluding the services)
- * that can be stored in the GATT database.
- * Note that certain characteristics and relative descriptors are added automatically during device initialization
- * so this parameters should be 9 plus the number of user Attributes
+ * (i.e. the number of characteristic + the number of characteristic values + the number of descriptors, excluding the
+ * services) that can be stored in the GATT database. Note that certain characteristics and relative descriptors are
+ * added automatically during device initialization so this parameters should be 9 plus the number of user Attributes
  */
-#define CFG_BLE_NUM_GATT_ATTRIBUTES 68
+#ifndef CFG_BLE_NUM_GATT_ATTRIBUTES
+  #define CFG_BLE_NUM_GATT_ATTRIBUTES 68
+#endif

 /**
  * Maximum supported ATT_MTU size
  * This parameter is ignored by the CPU2 when CFG_BLE_OPTIONS has SHCI_C2_BLE_INIT_OPTIONS_LL_ONLY flag set
  */
-#define CFG_BLE_MAX_ATT_MTU             (156)
+#ifndef CFG_BLE_MAX_ATT_MTU
+  #define CFG_BLE_MAX_ATT_MTU (156)
+#endif

 /**
  * Size of the storage area for Attribute values
- *  This value depends on the number of attributes used by application. In particular the sum of the following quantities (in octets) should be made for each attribute:
+ *  This value depends on the number of attributes used by application. In particular the sum of the following
+ *  quantities (in octets) should be made for each attribute:
  *  - attribute value length
  *  - 5, if UUID is 16 bit; 19, if UUID is 128 bit
  *  - 2, if server configuration descriptor is used
@@ -91,14 +99,18 @@
  *  The total amount of memory needed is the sum of the above quantities for each attribute.
  * This parameter is ignored by the CPU2 when CFG_BLE_OPTIONS has SHCI_C2_BLE_INIT_OPTIONS_LL_ONLY flag set
  */
+#ifndef CFG_BLE_ATT_VALUE_ARRAY_SIZE
 #define CFG_BLE_ATT_VALUE_ARRAY_SIZE    (1344)
+#endif

 /**
  * Prepare Write List size in terms of number of packet
  * This parameter is ignored by the CPU2 when CFG_BLE_OPTIONS has SHCI_C2_BLE_INIT_OPTIONS_LL_ONLY flag set
  */
 // #define CFG_BLE_PREPARE_WRITE_LIST_SIZE         BLE_PREP_WRITE_X_ATT(CFG_BLE_MAX_ATT_MTU)
-#define CFG_BLE_PREPARE_WRITE_LIST_SIZE         (0x3A)
+#ifndef CFG_BLE_PREPARE_WRITE_LIST_SIZE
+  #define CFG_BLE_PREPARE_WRITE_LIST_SIZE (0x3A)
+#endif

 /**
  * Number of allocated memory blocks
@@ -110,12 +122,16 @@
 /**
  * Enable or disable the Extended Packet length feature. Valid values are 0 or 1.
  */
-#define CFG_BLE_DATA_LENGTH_EXTENSION   1
+#ifndef CFG_BLE_DATA_LENGTH_EXTENSION
+  #define CFG_BLE_DATA_LENGTH_EXTENSION 1
+#endif

 /**
  * Sleep clock accuracy in Slave mode (ppm value)
  */
-#define CFG_BLE_SLAVE_SCA   500
+#ifndef CFG_BLE_SLAVE_SCA
+  #define CFG_BLE_SLAVE_SCA 500
+#endif

 /**
  * Sleep clock accuracy in Master mode
@@ -128,7 +144,9 @@
  * 6 : 21 ppm to 30 ppm
  * 7 : 0 ppm to 20 ppm
  */
-#define CFG_BLE_MASTER_SCA   0
+#ifndef CFG_BLE_MASTER_SCA
+  #define CFG_BLE_MASTER_SCA 0
+#endif

 /**
  * LsSource
@@ -136,21 +154,27 @@
  * - bit 0:   1: Calibration for the RF system wakeup clock source   0: No calibration for the RF system wakeup clock source
  * - bit 1:   1: STM32W5M Module device                              0: Other devices as STM32WBxx SOC, STM32WB1M module
  */
+#ifndef CFG_BLE_LSE_SOURCE
 #if defined(STM32WB5Mxx)
   #define CFG_BLE_LSE_SOURCE  (SHCI_C2_BLE_INIT_CFG_BLE_LSE_NOCALIB | SHCI_C2_BLE_INIT_CFG_BLE_LSE_MOD5MM_DEV)
 #else
   #define CFG_BLE_LSE_SOURCE  (SHCI_C2_BLE_INIT_CFG_BLE_LSE_NOCALIB | SHCI_C2_BLE_INIT_CFG_BLE_LSE_OTHER_DEV)
 #endif
+#endif

 /**
  * Start up time of the high speed (16 or 32 MHz) crystal oscillator in units of 625/256 us (~2.44 us)
  */
-#define CFG_BLE_HSE_STARTUP_TIME  0x148
+#ifndef CFG_BLE_HSE_STARTUP_TIME
+  #define CFG_BLE_HSE_STARTUP_TIME 0x148
+#endif

 /**
  * Maximum duration of the connection event when the device is in Slave mode in units of 625/256 us (~2.44 us)
  */
-#define CFG_BLE_MAX_CONN_EVENT_LENGTH  (0xFFFFFFFF)
+#ifndef CFG_BLE_MAX_CONN_EVENT_LENGTH
+  #define CFG_BLE_MAX_CONN_EVENT_LENGTH (0xFFFFFFFF)
+#endif

 /**
  * Viterbi Mode
@@ -237,5 +261,5 @@
   */

 #define CFG_BLE_RX_PATH_COMPENS    (0)
- #endif /*APP_CONF_H */
+#endif /* APP_CONF_DEFAULT_H */

-- 
2.25.1

